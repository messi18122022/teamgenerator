<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Teamgenerator</title>
    <style>
        body,
        table,
        th,
        td,
        tr,
        #csvLabel,
        #darkModeToggle {
            transition:
                background-color 0.35s ease,
                color 0.35s ease,
                border-color 0.35s ease;
        }
        body.dark-mode {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #121212;
            color: #e0e0e0;
            position: relative;
        }

        body.light-mode {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #ffffff;
            color: #000000;
            position: relative;
        }

        h1.dark-mode {
            color: #ffffff;
        }

        h1.light-mode {
            color: #000000;
        }

        table.dark-mode {
            border-collapse: collapse;
            width: auto;
            background-color: #1e1e1e;
        }

        table.light-mode {
            border-collapse: collapse;
            width: auto;
            background-color: #f9f9f9;
        }

        th.dark-mode, td.dark-mode {
            border: 1px solid #333;
            padding: 6px 12px;
            text-align: left;
            white-space: nowrap;
            color: #e0e0e0;
        }

        th.light-mode, td.light-mode {
            border: 1px solid #ccc;
            padding: 6px 12px;
            text-align: left;
            white-space: nowrap;
            color: #000000;
        }

        th.dark-mode {
            background-color: #2a2a2a;
        }

        th.light-mode {
            background-color: #e0e0e0;
        }

        tr.dark-mode:nth-child(even) {
            background-color: #1a1a1a;
        }

        tr.dark-mode:nth-child(odd) {
            background-color: #1e1e1e;
        }

        tr.light-mode:nth-child(even) {
            background-color: #f2f2f2;
        }

        tr.light-mode:nth-child(odd) {
            background-color: #ffffff;
        }

        #status.dark-mode {
            margin-top: 5px;
            color: #b0b0b0;
        }

        #status.light-mode {
            margin-top: 5px;
            color: #505050;
        }

        tr.abwesend {
            opacity: 0.2;
        }

        th.anwesend-spalte.dark-mode,
        td.anwesend-spalte.dark-mode {
            width: auto;
            text-align: center;
        }

        th.anwesend-spalte.light-mode,
        td.anwesend-spalte.light-mode {
            width: auto;
            text-align: center;
        }

        td.anwesend-spalte.dark-mode {
            padding-left: 18px;
            padding-right: 18px;
            cursor: pointer;
            background-color: #1e1e1e;
        }

        td.anwesend-spalte.light-mode {
            padding-left: 18px;
            padding-right: 18px;
            cursor: pointer;
            background-color: #f9f9f9;
        }

        td.anwesend-spalte.dark-mode input[type="checkbox"] {
            transform: scaleX(1.6);
            cursor: pointer;
        }

        td.anwesend-spalte.light-mode input[type="checkbox"] {
            transform: scaleX(1.6);
            cursor: pointer;
        }

        tr.anwesend td.anwesend-spalte.dark-mode {
            background-color: #2e7d32;
        }

        tr.anwesend td.anwesend-spalte.light-mode {
            background-color: #81c784;
        }

        tr.abwesend td.anwesend-spalte.dark-mode {
            background-color: #444;
        }

        tr.abwesend td.anwesend-spalte.light-mode {
            background-color: #ccc;
        }

        #darkModeToggle {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 6px 12px;
            cursor: pointer;
            background-color: #444;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
        }

        body.light-mode #darkModeToggle {
            background-color: #ddd;
            color: #000;
        }
        #toggleListe {
            margin-bottom: 10px;
            padding: 6px 12px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }
        #csvLabel {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            margin-bottom: 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            user-select: none;
            border: 1px solid;
        }

        body.dark-mode #csvLabel {
            background-color: #1e1e1e;
            border-color: #444;
            color: #e0e0e0;
        }

        body.light-mode #csvLabel {
            background-color: #f2f2f2;
            border-color: #ccc;
            color: #000000;
        }

        #csvIcon {
            font-size: 18px;
        }
        .chevron {
            width: 10px;
            height: 10px;
            border-right: 2px solid currentColor;
            border-bottom: 2px solid currentColor;
            transform: rotate(-45deg);
            transition: transform 0.2s ease;
            margin-left: 2px;
        }

        .chevron.offen {
            transform: rotate(45deg);
        }
    /* Slide-Up/Down Animation nur f√ºr Inhalte, Titel bleiben sichtbar */
    #spielerTabelle,
    #anwesendZaehler,
    #csvLabel,
    #einstellungenSection {
        overflow: hidden;
        transition: max-height 0.4s ease, margin 0.4s ease, padding 0.4s ease;
        max-height: 2000px;
    }

    .inhalt {
        transition: max-height 0.4s ease, margin 0.4s ease, padding 0.4s ease;
        max-height: 2000px;
        overflow: hidden;
    }

    .inhalt.eingeklappt {
        max-height: 0 !important;
        margin: 0 !important;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        pointer-events: none;
    }

    .inhalt.ausgeklappt {
        max-height: 2000px;
        margin: initial;
        padding-top: initial;
        padding-bottom: initial;
        pointer-events: auto;
    }

        /* Einheitliche Gr√∂√üe f√ºr alle Abschnittstitel */
        h1#titelToggle,
        h2#einstellungenToggle,
        h2#teamsToggle {
            font-size: 20px;
            font-weight: 600;
        }

        /* Sch√∂ne Eingabefelder f√ºr Einstellungen */
        #einstellungenInhalt input {
            width: 100px;
            padding: 8px 10px;
            font-size: 14px;
            border: 1px solid #888;
            border-radius: 6px;
            background-color: #f9f9f9;
            color: #000;
            outline: none;
            transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
        }

        #einstellungenInhalt input:focus {
            border-color: #2196f3;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.5);
            background-color: #e3f2fd;
        }

        body.dark-mode #einstellungenInhalt input {
            background-color: #1e1e1e;
            color: #e0e0e0;
            border: 1px solid #555;
        }

        body.dark-mode #einstellungenInhalt input:focus {
            background-color: #2c3e50;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.5);
        }

        #einstellungenInhalt input.dimmed {
            opacity: 0.5;
        }
    .drop-target {
        outline: 2px dashed #2196f3;
        background-color: rgba(33, 150, 243, 0.1);
    }
    .action-button {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 15px;
        user-select: none;
        border: 1px solid;
        background-color: transparent;
    }

    body.dark-mode .action-button {
        background-color: #1e1e1e;
        border-color: #444;
        color: #e0e0e0;
    }

    body.light-mode .action-button {
        background-color: #f2f2f2;
        border-color: #ccc;
        color: #000000;
    }

    .action-button:hover {
        filter: brightness(1.05);
    }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="dark-mode">

<button id="darkModeToggle">Light Mode</button>

<h1 class="dark-mode" id="titelToggle" style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
    <span id="chevron" class="chevron geschlossen"></span>
    Spielerliste
</h1>
<div id="spielerListeInhalt" class="inhalt ausgeklappt">
    <label id="csvLabel">
        <span id="csvIcon">üìÑ</span>
        <span id="csvText">Datei ausw√§hlen</span>
        <input type="file" id="csvInput" accept=".xlsx" hidden>
    </label>

    <table id="spielerTabelle" class="dark-mode" style="display: none;">
        <thead>
            <tr>
                <th class="anwesend-spalte dark-mode">Status</th>
                <th class="dark-mode">Name</th>
                <th class="dark-mode">Mannschaft</th>
                <th class="dark-mode">St√§rke</th>
            </tr>
        </thead>
        <tbody>
            <!-- Spieler werden hier eingefuegt -->
        </tbody>
    </table>

    <p id="anwesendZaehler" style="display: none;"><em>0 Spieler anwesend.</em></p>
</div>

<h2 id="einstellungenToggle" style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
    <span id="chevronEinstellungen" class="chevron geschlossen"></span>
    Einstellungen
</h2>
<div id="einstellungenInhalt" class="inhalt ausgeklappt">
    <label>
        Spieler pro Team: <input type="number" id="spielerProTeam" min="1">
    </label>
    <label>
        Anzahl Teams: <input type="number" id="anzahlTeams" min="1">
    </label>
</div>

<h2 id="teamsToggle" style="cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
    <span id="chevronTeams" class="chevron geschlossen"></span>
    Teams generieren
</h2>
<div id="teamsInhalt" class="inhalt ausgeklappt">
    <button id="teamsGenerierenBtn" class="action-button">
        <span>üë•</span>
        <span>Teams generieren</span>
    </button>
    <div id="teamsOutput" style="display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap;"></div>
</div>

<script>
    const input = document.getElementById('csvInput');
    const tbody = document.querySelector('#spielerTabelle tbody');
    const anwesendZaehler = document.getElementById('anwesendZaehler');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const body = document.body;
    const h1 = document.querySelector('h1');
    const table = document.getElementById('spielerTabelle');
    const theadThs = table.querySelectorAll('thead th');
    const anwesendZaehlerP = anwesendZaehler;
    const titelToggle = document.getElementById('titelToggle');
    const chevron = document.getElementById('chevron');
    const csvInput = document.getElementById('csvInput');
    const csvText = document.getElementById('csvText');
    const spielerListeInhalt = document.getElementById('spielerListeInhalt');

    function setModeClasses(mode) {
        // Set body class
        body.className = mode;

        // Set h1 class
        h1.className = mode;

        // Set table class
        table.className = mode;

        // Set thead th classes
        theadThs.forEach(th => {
            if (th.classList.contains('anwesend-spalte')) {
                th.className = 'anwesend-spalte ' + mode;
            } else {
                th.className = mode;
            }
        });

        // Set tbody tr and td classes
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(tr => {
            // Remove previous dark-mode/light-mode classes from tr and tds
            tr.querySelectorAll('td').forEach(td => {
                td.classList.remove('dark-mode', 'light-mode');
            });
            tr.classList.remove('dark-mode', 'light-mode');

            // Add mode classes
            tr.classList.add(mode);
            tr.querySelectorAll('td').forEach(td => {
                if (td.classList.contains('anwesend-spalte')) {
                    td.classList.add(mode);
                } else {
                    td.classList.add(mode);
                }
            });
        });

        // --- Team-Tabellen ebenfalls an Modus anpassen ---
        document.querySelectorAll('#teamsOutput table').forEach(teamTable => {
            teamTable.className = mode;

            teamTable.querySelectorAll('th, td, tr').forEach(el => {
                el.classList.remove('dark-mode', 'light-mode');
                el.classList.add(mode);
            });
        });

        // Set anwesendZaehler color for light mode
        if (mode === 'light-mode') {
            anwesendZaehlerP.style.color = '#000000';
        } else {
            anwesendZaehlerP.style.color = '';
        }
    }

    darkModeToggle.addEventListener('click', () => {
        if (body.classList.contains('dark-mode')) {
            setModeClasses('light-mode');
            darkModeToggle.textContent = 'Dark Mode';
        } else {
            setModeClasses('dark-mode');
            darkModeToggle.textContent = 'Light Mode';
        }
    });

    titelToggle.addEventListener('click', () => {
        if (spielerListeInhalt.classList.contains('eingeklappt')) {
            spielerListeInhalt.classList.remove('eingeklappt');
            spielerListeInhalt.classList.add('ausgeklappt');
            chevron.classList.add('offen');
        } else {
            spielerListeInhalt.classList.remove('ausgeklappt');
            spielerListeInhalt.classList.add('eingeklappt');
            chevron.classList.remove('offen');
        }
    });

    input.addEventListener('change', () => {
        const file = input.files[0];
        if (file) {
            csvText.textContent = file.name;
        }
        if (!file) return;
        table.style.display = '';
        anwesendZaehler.style.display = '';

        const reader = new FileReader();

        reader.onload = event => {
            tbody.innerHTML = '';

            function updateZaehler() {
                const zeilen = tbody.querySelectorAll('tr');
                let count = 0;

                zeilen.forEach(zeile => {
                    if (zeile.classList.contains('anwesend')) {
                        count++;
                        zeile.classList.remove('abwesend');
                    } else {
                        zeile.classList.add('abwesend');
                    }
                });

                anwesendZaehler.innerHTML = '<em>' + count + ' Spieler anwesend.</em>';
            }

            const data = new Uint8Array(event.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];

            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            // Kopfzeile entfernen
            rows.shift();

            rows.forEach(spalten => {
                if (spalten.length < 3) return;

                const name = String(spalten[0]).trim();
                const staerke = String(spalten[1]).trim();
                const mannschaft = String(spalten[2]).trim();

                const tr = document.createElement('tr');
                tr.classList.add('anwesend', body.className);

                const tdStatus = document.createElement('td');
                tdStatus.classList.add('anwesend-spalte', body.className);
                tdStatus.addEventListener('click', () => {
                    tr.classList.toggle('anwesend');
                    updateZaehler();
                });
                tr.appendChild(tdStatus);

                [name, mannschaft, staerke].forEach(wert => {
                    const td = document.createElement('td');
                    td.textContent = wert;
                    td.classList.add(body.className);
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            updateZaehler();
        };

        reader.readAsArrayBuffer(file);
    });

    // Einstellungen-Accordion
    const einstellungenToggle = document.getElementById('einstellungenToggle');
    const chevronEinstellungen = document.getElementById('chevronEinstellungen');
    const einstellungenInhalt = document.getElementById('einstellungenInhalt');
    const inputSpielerProTeam = document.getElementById('spielerProTeam');
    const inputAnzahlTeams = document.getElementById('anzahlTeams');

    // Einstellungen initial als ausgeklappt markieren (bereits im HTML)

    einstellungenToggle.addEventListener('click', () => {
        if (einstellungenInhalt.classList.contains('eingeklappt')) {
            einstellungenInhalt.classList.remove('eingeklappt');
            einstellungenInhalt.classList.add('ausgeklappt');
            chevronEinstellungen.classList.add('offen');
        } else {
            einstellungenInhalt.classList.remove('ausgeklappt');
            einstellungenInhalt.classList.add('eingeklappt');
            chevronEinstellungen.classList.remove('offen');
        }
    });

    // Teams-Accordion
    const teamsToggle = document.getElementById('teamsToggle');
    const chevronTeams = document.getElementById('chevronTeams');
    const teamsInhalt = document.getElementById('teamsInhalt');
    const teamsBtn = document.getElementById('teamsGenerierenBtn');
    const teamsOutput = document.getElementById('teamsOutput');

    teamsToggle.addEventListener('click', () => {
        if (teamsInhalt.classList.contains('eingeklappt')) {
            teamsInhalt.classList.remove('eingeklappt');
            teamsInhalt.classList.add('ausgeklappt');
            chevronTeams.classList.add('offen');
        } else {
            teamsInhalt.classList.remove('ausgeklappt');
            teamsInhalt.classList.add('eingeklappt');
            chevronTeams.classList.remove('offen');
        }
    });

    teamsBtn.addEventListener('click', () => {
        teamsOutput.innerHTML = '';

        const spieler = [];
        tbody.querySelectorAll('tr.anwesend').forEach(tr => {
            const tds = tr.querySelectorAll('td');
            spieler.push({
                name: tds[1].textContent,
                mannschaft: tds[2].textContent,
                staerke: parseInt(tds[3].textContent, 10)
            });
        });

        if (spieler.length === 0) {
            teamsOutput.innerHTML = '<em>Keine anwesenden Spieler.</em>';
            return;
        }

        const spielerProTeam = parseInt(inputSpielerProTeam.value, 10);
        const anzahlTeams = parseInt(inputAnzahlTeams.value, 10);

        let teams = [];

        if (anzahlTeams) {
            for (let i = 0; i < anzahlTeams; i++) teams.push([]);
        } else if (spielerProTeam) {
            // spielerProTeam ist MINDESTANZAHL
            const min = spielerProTeam;
            const max = spielerProTeam + 1;

            // Anzahl Teams so berechnen, dass niemand unter dem Minimum ist
            const teamCount = Math.floor(spieler.length / min);

            if (teamCount === 0) {
                teamsOutput.innerHTML = '<em>Zu wenige Spieler f√ºr diese Einstellung.</em>';
                return;
            }

            for (let i = 0; i < teamCount; i++) teams.push([]);
        } else {
            teamsOutput.innerHTML = '<em>Bitte Einstellungen setzen.</em>';
            return;
        }

        // === H√ñCHSTE PRIORIT√ÑT: Mannschaften trennen ===

        // Spieler nach Altersstufe gruppieren
        const gruppen = {};
        spieler.forEach(sp => {
            if (!gruppen[sp.mannschaft]) gruppen[sp.mannschaft] = [];
            gruppen[sp.mannschaft].push(sp);
        });

        // Altersstufen numerisch sortieren (√§lter zuerst)
        const altersstufen = Object.keys(gruppen).sort((a, b) => {
            return parseInt(b.replace(/\D/g, ''), 10) - parseInt(a.replace(/\D/g, ''), 10);
        });

        let teamCursor = 0;

        altersstufen.forEach((stufe, index) => {
            const gruppe = gruppen[stufe].sort((a, b) => b.staerke - a.staerke);

            // Wie viele Teams sollen diese Altersstufe prim√§r f√ºllen?
            const anteil = Math.round((gruppe.length / spieler.length) * teams.length) || 1;
            const zielTeams = teams.slice(teamCursor, teamCursor + anteil);

            // Falls nicht genug freie Teams √ºbrig sind
            const verwendeteTeams = zielTeams.length > 0 ? zielTeams : teams;

            let i = 0;
            gruppe.forEach(sp => {
                verwendeteTeams[i % verwendeteTeams.length].push(sp);
                i++;
            });

            teamCursor += verwendeteTeams.length;
        });

        // === NUR FALLS LEERE TEAMS EXISTIEREN: mit n√§chstj√ºngerer Altersstufe auff√ºllen ===
        teams.forEach((team, idx) => {
            if (team.length > 0) return;

            // n√§chstgelegene Altersstufe suchen
            const alleSpieler = teams.flat();
            const kandidaten = alleSpieler.filter(sp => {
                const alter = parseInt(sp.mannschaft.replace(/\D/g, ''), 10);
                return Math.abs(alter - parseInt(altersstufen[0].replace(/\D/g, ''), 10)) <= 1;
            });

            if (kandidaten.length > 0) {
                team.push(kandidaten.pop());
            }
        });

        // === GLOBALE TEAMGROESSEN-REGEL ===
        if (spielerProTeam) {
            const min = spielerProTeam;
            const max = spielerProTeam + 1;

            let changed = true;

            // Solange es Teams mit > max und Teams mit < min gibt, ausgleichen
            while (changed) {
                changed = false;

                const zuGross = teams.find(t => t.length > max);
                const zuKlein = teams.find(t => t.length < min);

                if (zuGross && zuKlein) {
                    // Spieler vom groessten Team ins kleinste verschieben
                    const spielerVerschieben = zuGross.pop();
                    zuKlein.push(spielerVerschieben);
                    changed = true;
                }
            }
        }

        teams.forEach((team, index) => {
            const table = document.createElement('table');
            table.className = body.className;

            const thead = document.createElement('thead');
            const trh = document.createElement('tr');
            const th = document.createElement('th');
            th.colSpan = 3;
            th.textContent = 'Team ' + (index + 1);
            th.className = body.className;
            trh.appendChild(th);
            thead.appendChild(trh);
            table.appendChild(thead);

            const tbodyTeam = document.createElement('tbody');
            let sumStaerke = 0;

            team.forEach(sp => {
                sumStaerke += sp.staerke;
                const tr = document.createElement('tr');
                tr.className = body.className;

                [sp.name, sp.mannschaft, sp.staerke].forEach(val => {
                    const td = document.createElement('td');
                    td.textContent = val;
                    td.className = body.className;
                    tr.appendChild(td);
                });

                tbodyTeam.appendChild(tr);
            });

            const avgRow = document.createElement('tr');
            const avgTd = document.createElement('td');
            avgTd.colSpan = 3;
            avgTd.innerHTML = '<em>Durchschnittsst√§rke: ' + (sumStaerke / team.length).toFixed(2) + '</em>';
            avgTd.className = body.className;
            avgRow.appendChild(avgTd);
            tbodyTeam.appendChild(avgRow);

            table.appendChild(tbodyTeam);
            teamsOutput.appendChild(table);
        });
    });
</script>
<script>
function updateTeamAvg(table) {
    const rows = Array.from(table.querySelectorAll('tbody tr')).filter(tr => !tr.querySelector('em'));
    if (rows.length === 0) return;

    let sum = 0;
    rows.forEach(tr => {
        const staerke = parseInt(tr.children[2].textContent, 10);
        sum += staerke;
    });

    let avgRow = Array.from(table.querySelectorAll('tbody tr')).find(tr => tr.querySelector('em'));
    if (!avgRow) {
        avgRow = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.innerHTML = '';
        avgRow.appendChild(td);
        avgRow.className = body.className;
        table.querySelector('tbody').appendChild(avgRow);
    }

    avgRow.querySelector('td').innerHTML = '<em>Durchschnittsst√§rke: ' + (sum / rows.length).toFixed(2) + '</em>';
}

function makeRowsDraggable() {
    // Nur Spielerzeilen im tbody draggable machen, nicht Kopfzeilen (th)
    const allRows = document.querySelectorAll('#teamsOutput tbody tr');
    allRows.forEach(tr => {
        // Durchschnittszeile (mit <em>) nicht draggable machen
        if (tr.querySelector('em')) return;
        tr.setAttribute('draggable', 'true');

        tr.addEventListener('dragstart', e => {
            e.dataTransfer.setData('text/plain', '');
            tr.classList.add('dragging');
            window.draggedRow = tr;

            // Ganze Zeile als Drag-Image verwenden
            const rect = tr.getBoundingClientRect();
            const clone = tr.cloneNode(true);
            clone.style.position = 'absolute';
            clone.style.top = '-9999px';
            document.body.appendChild(clone);
            e.dataTransfer.setDragImage(clone, rect.width / 2, rect.height / 2);
            setTimeout(() => document.body.removeChild(clone), 0);
        });

        tr.addEventListener('dragend', () => {
            tr.classList.remove('dragging');
            document.querySelectorAll('.drop-target').forEach(el => el.classList.remove('drop-target'));
            window.draggedRow = null;
        });

        tr.addEventListener('dragover', e => {
            e.preventDefault();
            const dragged = window.draggedRow;
            if (!dragged || dragged === tr || tr.querySelector('em')) return;
            tr.classList.add('drop-target');
        });

        tr.addEventListener('dragleave', e => {
            tr.classList.remove('drop-target');
        });

        tr.addEventListener('drop', e => {
            e.preventDefault();
            const dragged = window.draggedRow;
            if (!dragged || dragged === tr) return;

            const sourceTbody = dragged.closest('table').querySelector('tbody');
            const targetTbody = tr.closest('table').querySelector('tbody');

            const avgRowTarget = Array.from(targetTbody.querySelectorAll('tr')).find(r => r.querySelector('em'));

            // Spieler nur verschieben, kein Tausch
            sourceTbody.removeChild(dragged);
            targetTbody.insertBefore(dragged, avgRowTarget);

            tr.classList.remove('drop-target');

            updateTeamAvg(sourceTbody.closest('table'));
            updateTeamAvg(targetTbody.closest('table'));
        });
    });

    const tables = document.querySelectorAll('#teamsOutput table');
    tables.forEach(table => {
        table.addEventListener('dragover', e => e.preventDefault());
        table.addEventListener('drop', e => {
            e.preventDefault();
            const dragged = window.draggedRow;
            if (!dragged) return;

            const tbody = table.querySelector('tbody');
            const avgRow = Array.from(tbody.querySelectorAll('tr')).find(r => r.querySelector('em'));
            tbody.insertBefore(dragged, avgRow);
            updateTeamAvg(tbody.closest('table'));

            // Pr√ºfen, ob das Quellteam leer ist (nur noch avgRow) und l√∂schen
            document.querySelectorAll('#teamsOutput table').forEach(tbl => {
                const tBodyCheck = tbl.querySelector('tbody');
                const rows = Array.from(tBodyCheck.querySelectorAll('tr')).filter(tr => !tr.querySelector('em'));
                if (rows.length === 0) {
                    tbl.remove();
                }
            });
        });
    });
}

// --- Neues Team-Placeholder f√ºr Drag&Drop hinzuf√ºgen ---
function createNewTeamPlaceholder() {
    let placeholder = document.getElementById('newTeamPlaceholder');
    if (!placeholder) {
        placeholder = document.createElement('div');
        placeholder.id = 'newTeamPlaceholder';
        placeholder.style.display = 'flex';
        placeholder.style.flexDirection = 'column';
        placeholder.style.alignItems = 'center';
        placeholder.style.justifyContent = 'center';
        placeholder.style.width = '150px';
        placeholder.style.height = '50px';
        placeholder.style.border = '2px dashed #2196f3';
        placeholder.style.marginTop = '15px';
        placeholder.style.cursor = 'pointer';
        placeholder.style.color = '#2196f3';
        placeholder.style.fontSize = '24px';
        placeholder.textContent = '+';
        teamsOutput.appendChild(placeholder);

        // Drag & Drop EventListener f√ºr den Placeholder
        placeholder.addEventListener('dragover', e => e.preventDefault());
        placeholder.addEventListener('dragenter', e => placeholder.style.backgroundColor = 'rgba(33,150,243,0.1)');
        placeholder.addEventListener('dragleave', e => placeholder.style.backgroundColor = '');
        placeholder.addEventListener('drop', e => {
            e.preventDefault();
            const dragged = window.draggedRow;
            if (!dragged) return;
            placeholder.style.backgroundColor = '';

            // Neues Team erstellen mit dem gezogenen Spieler
            const table = document.createElement('table');
            table.className = body.className;

            const thead = document.createElement('thead');
            const trh = document.createElement('tr');
            const th = document.createElement('th');
            th.colSpan = 3;
            th.textContent = 'Team ' + (teamsOutput.querySelectorAll('table').length + 1);
            th.className = body.className;
            trh.appendChild(th);
            thead.appendChild(trh);
            table.appendChild(thead);

            const tbodyTeam = document.createElement('tbody');

            const tr = dragged;
            const oldTbody = tr.parentNode;
            oldTbody.removeChild(tr);
            updateTeamAvg(oldTbody.closest('table'));

            tbodyTeam.appendChild(tr);

            const avgRow = document.createElement('tr');
            const avgTd = document.createElement('td');
            avgTd.colSpan = 3;
            avgTd.innerHTML = '<em>Durchschnittsst√§rke: ' + parseInt(tr.children[2].textContent,10) + '</em>';
            avgTd.className = body.className;
            avgRow.appendChild(avgTd);
            tbodyTeam.appendChild(avgRow);

            table.appendChild(tbodyTeam);
            teamsOutput.insertBefore(table, placeholder);


            makeRowsDraggable();
        });

        // Klick-Listener f√ºr leeres Team
        placeholder.addEventListener('click', () => {
            const table = document.createElement('table');
            table.className = body.className;

            const thead = document.createElement('thead');
            const trh = document.createElement('tr');
            const th = document.createElement('th');
            th.colSpan = 3;
            th.textContent = 'Team ' + (teamsOutput.querySelectorAll('table').length + 1);
            th.className = body.className;
            trh.appendChild(th);
            thead.appendChild(trh);
            table.appendChild(thead);

            const tbodyTeam = document.createElement('tbody');

            const avgRow = document.createElement('tr');
            const avgTd = document.createElement('td');
            avgTd.colSpan = 3;
            avgTd.innerHTML = '<em>Durchschnittsst√§rke: 0.00</em>';
            avgTd.className = body.className;
            avgRow.appendChild(avgTd);
            tbodyTeam.appendChild(avgRow);

            table.appendChild(tbodyTeam);
            teamsOutput.insertBefore(table, placeholder);


            makeRowsDraggable();
        });
    }
}

// Nach jedem Generieren der Teams:
teamsBtn.addEventListener('click', () => {
    setTimeout(() => {
        makeRowsDraggable();
        createNewTeamPlaceholder();
    }, 50);
});
</script>
</body>
</html>
